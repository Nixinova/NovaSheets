#!/usr/bin/env node
const e="0.6.0",NM=Number,RE=RegExp;try{fs=require("fs")}catch(e){}function t(e,t=8){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t);return Math.abs(r).toString(16).substring(0,t).padStart(t,"0")}function r(e,t){return"func"==e?r(`Unknown value "${t[1]}" in built-in function ${t[0]}${t[2]}.`):console.warn("<NovaSheets>",e)}function parseNovaSheets(e){const l=String.raw;try{window}catch(e){window={}}let s=[],n=[],i,o;if(e&&e.input)a(e.input,e.output);else if(e||Object.is(window,{}))s=[e.toString()],n="raw";else{try{i=document.querySelectorAll('link[rel="novasheet" i], link[rel="novasheets" i]'),o=document.querySelectorAll('[type="novasheet" i], [type="novasheets" i]')}catch(e){try{i=document.querySelectorAll('link[rel="novasheet"], link[rel="novasheets"]'),o=document.querySelectorAll('[type="novasheet"], [type="novasheets"]')}catch(e){}}let e={full:[],rel:[]};for(let t of i)e.full.push(t.href),e.rel.push(t.getAttribute("href"));for(let t in e.full)try{let r=new XMLHttpRequest;if(r.open("GET",e.full[t],!1),r.send(),404==r.status)throw 404;let a=r.responseText;s.push(a.toString()),n.push(e.rel[t])}catch(a){r(`File "${e.rel[t]}" cannot be accessed.`)}for(let e of o)s.push(e.innerHTML),n.push("inline")}window.randomHash=window.randomHash||t(Math.random().toString(),6);for(let a in s){s[a]=s[a].replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/(?<![a-z]+:)\n?\/\/.*$/gm,"").replace(/(?:@var.+?=.*$|@var\s*[^=]*(?=\n\s*@var\s.))(?!\n\s*@endvar)/gm,"$& @endvar").replace(/@(var|const|endvar)/g,"\n$&").replace(/@const\s*[A-Z_]+\s*(true|false|[0-9]+)|@endvar/g,"$&\n");let i=s[a].split("\n"),o="",c=[],p=[];for(let e in i)i[e]=i[e].replace(/[\r\n]/g," "),o+="\n"+i[e];o=o.replace(/\s*(?:@var.*?((?=@var)|@endvar)|@const\s*[A-Z_]+\s*(true|false|[0-9]+))/gms," ").replace(/\/\*(.+?)\*\//gs,(e,t)=>e.startsWith("/*[")&&e.endsWith("]*/")?e.replace(/^\/\*\[(.+)\]\*\/$/,"/*$1*/"):e.startsWith("/*/")||e.endsWith("/*/")?e:(c.indexOf(t)<0&&c.push(t),"/*COMMENT#"+c.indexOf(t)+"*/")).replace(/\/\*\/(.+?)\/\*\//gs,(e,t)=>(p.indexOf(t)<0&&p.push(t),"/*STATIC#"+p.indexOf(t)+"*/"));let $=[],h=50,u=5,m=10,g=!1;for(let e in i)if(i[e].match(/^\s*@var\s/)){let t=i[e].replace(/^\s*@var\s/,"").split("="),r=i.slice(e),a;for(let e in r)if(r[e].match(/^\s*@endvar\s*$|^\s*@var\s/)&&0!=e){a=e;break}let l=t[0].trim(),s=(t.slice(1).join("=")||"")+r.slice(1,a).join(" ");$.push({nm:l.split("|")[0].trim(),ct:s.trim()})}else i[e].match(/^\s*@const\s*MAX_RECURSION\s/)?h=parseInt(i[e].split("MAX_RECURSION")[1]):i[e].match(/^\s*@const\s*MAX_MATH_RECURSION\s/)?u=parseInt(i[e].split("MAX_MATH_RECURSION")[1]):i[e].match(/^\s*@const\s*MAX_ARGUMENTS\s/)?m=parseInt(i[e].split("MAX_ARGUMENTS")[1]):i[e].match(/^\s*@const\s*KEEP_NAN\s/)&&(g=!["0","false"].includes(i[e].split("KEEP_NAN")[1].trim()));const f=l`(?:[0-9]*\.?[0-9]+)`,d=l`(?:0x[0-9a-f]*\.?[0-9a-f]+|0b[01]*\.?[01]+|0o[0-7]*\.?[0-7]+|${f})`,b=l`(?:\(\s*${d}\s*\)|${d})`,v=l`(?:\(\s*${d}\s*\)|${d})\s*[a-z]*[-+*^/e\s]+(?:\(\s*${d}\s*\)|${d})\s*[a-z]*`,M=l`\s*(?:em|rem|en|ex|px|pt|pc|cm|mm|m(?![ms])|ft|in|s|ms)`,x=e=>l`(?:[-e^*/+\s${e?"()":""}]+(?=\d|\.))`,N=e=>{const t=l`\(\s*`,r=l`\s*\)`,a=`${d}${M}?`,s=`(?:${t}${a}${r}|${a})`,n=e.op||x(e.b);let i=l`(?:(?:${s}\s*${n}\s*)+(?:${a}))`;return l`\(${i}\)|${i}`},E=e=>g?NM(e):isNaN(NM(e))?"":NM(e),w=()=>{for(let e=0;e<u&&o.match(RE(v));e++)o=o.replace(RE(N({}),"g"),e=>{let t=!e.match(/[-+e^*/]/),r=e.match(RE(l`${M}\s-?${d}`));if(t||r)return e;let a=e.match(RE(M,"g"))||[],s=a[a.length-1]||"",n=e.replace(RE(`(${f})s*(${M})`,"g"),(e,t,r)=>{switch(r){case"mm":case"ms":return s=r[1],E(t)/1e3;case"cm":return s="m",E(t)/100;case"in":return s="m",.0254*E(t);case"ft":return s="m",.3048*E(t);default:return e}}).replace(RE(M,"g"),"").replace(/\d\s*e\s*\d/g,"$&".replace(/\s/g,"")).replace(/--/g,"- -").replace(/\^/g,"**");try{return eval(n)+s}catch(e){return n+s}})},y=e=>e.replace(/[.*+?^/${}()|[\]\\]/g,"\\$&"),S=(e,t)=>{let r=!e||e===1/0||NM.isNaN(e);return r&&g?"NaN":r&&!g?t||0:e},R=(e,t,r={})=>{w();let a=RE(l`\$\(\s*${e}\b`),s=o.match(a);if(!s)return;let n,i=s?o.indexOf(s[0]):-1,c=o.substr(i),p="",$=0;for(let e=0;e<c.length&&(p+=c[e],$>0&&(n=!0),"("===c[e]&&$++,")"===c[e]&&$--,!n||0!==$);e++)if(e==c.length-1&&$>0)return;if(!p.trim("force")||r.nN&&p.match(/.+\$\(/))return;let h=r.nT?"|":/\s*\|\s*/,u=p.replace(/^\$\(\s*|\s*\)$/g,"").split(h);for(let e=0;e<m;e++)u[e]||(u[e]="");u[0]=p,u=u.slice(0,u.indexOf("")),o=o.replace(p,t(...u))};let A=0,W;for(;(o.indexOf("$(")>-1||A<1)&&A++<h&&W!==o;){W=o;for(let e in $)R($[e].nm,(t,...r)=>{let a=$[e].ct;for(let e in r){if(!r[e])continue;let t=r[e].split("="),s=t[1]?t[0].trim():+e+1,n=t[1]?t[1].trim():t[0].trim();a=a.replace(RE(l`\$\[${s}[^\]]*\]`,"g"),n)}return a=a.replace(/\$\[.*?(?:\|([^\]]*))?\]/g,"$1"),a});R("@each",(e,t,r,a,...l)=>{let s=[],n=t.trim().split(r.trim());for(let e in n){let t=l.join("|").replace(/\$i/gi,NM(e)+1).replace(/\$v\[([0-9]+)([-+*/][0-9]+)?\]/g,(e,t,r)=>n[eval(NM(t-1)+(r||0))]).replace(/.?\s*undefined/g,"").replace(/\$v/gi,n[e]);s.push(t)}return s.join(a)},{nT:!0}),R("@repeat",(e,t,...r)=>{let a="";for(let e=0;e<NM(t);e++)a+=r.join("|").replace(/\$i/gi,NM(e)+1);return a},{nT:!0}),R("@e",e=>Math.E),R("@pi",e=>Math.PI),R("@mod",(e,t,...r)=>S(t%r,e)),R("@sin",(e,t)=>S(Math.sin(t),e)),R("@asin",(e,t)=>S(Math.asin(t),e)),R("@cos",(e,t)=>S(Math.cos(t),e)),R("@acos",(e,t)=>S(Math.acos(t),e)),R("@tan",(e,t)=>S(Math.tan(t),e)),R("@atan",(e,t)=>S(Math.atan(t),e)),R("@abs",(e,t)=>S(Math.abs(t),e)),R("@floor",(e,t)=>S(Math.floor(t),e)),R("@ceil",(e,t)=>S(Math.ceil(t),e)),R("@percent",(e,t)=>S(100*E(t)+"%",e)),R("@log",(e,t,r)=>S(Math.log(r)/(t?Math.log(t):1),e)),R("@root",(e,t,r)=>S(Math.pow(r||t,1/(r?t:2)),e)),R("@round",(e,t,r)=>{let a=E(t)+NM.EPSILON,l=Math.pow(10,r||0);return S(Math.round(a*l)/l,e)}),R("@(?:max|min)",(e,...t)=>{let r=[];for(let e of t)e&&r.push(e);let a=e.includes("@min")?Math.min(...r):Math.max(...r);return S(a,e)}),R("@clamp",(e,t,r,a)=>{let l=NM(t),s=NM(r),n=NM(a);return n<s&&([s,n]=[n,s]),S(l<=s?s:l>=n?n:l,e)}),R("@degrees",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RE(f),"")];if("grad"===a)return.9*r;let l=r/Math.PI*180;return S(l,e)}),R("@radians",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RE(f),"")];if("grad"===a)return r*Math.PI/200;let l=r*Math.PI/180;return S(l,e)}),R("@gradians",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RE(f),"")];return"rad"===a?r/Math.PI*200:S(r/.9,e)}),R("@extract",(e,t,r,a)=>t.split(r)[E(a)-1]||""),R("@encode",(e,t)=>encodeURIComponent(t)),R("@length",(e,t)=>t.trim().length),R("@replace",(e,...t)=>{let r=t[0].trim(),a=t.slice(1,-1).join("|").trim()||" ",l=t.slice(-1)[0].trim(),s=a.startsWith("/");if(s){let e=a.trim().match(/\/(.+?)\/([gimusy]*)/).slice(1);a=RE(e[0],e[1]||"s")}return r.replace(s?a:RE(y(a),"g"),l)},{nT:!0});const e=e=>Math.floor(NM(e)/255*100),t=e=>Math.ceil(255*NM(e.replace("%",""))/100),a=e=>NM(e).toString(16).padStart(2,"0"),s=(t,r)=>{let a=parseInt(t.replace(/#?(.{0,6})(..)?$/,"$1"),16),l=a>>16&255,s=a>>8&255,n=255&a,i=r&&e(parseInt(r,16));return null!=i?`rgba(${l}, ${s}, ${n}, ${i})`:`rgb(${l}, ${s}, ${n})`},n=e=>{let t=e.replace("#","");return t?1===t.length?s(t.repeat(6)):2===t.length?s(t[0].repeat(6),t[1].repeat(2)):3===t.length?s(t[0]+t[0]+t[1]+t[1]+t[2]+t[2]):4===t.length?s(t[0]+t[0]+t[1]+t[1]+t[2]+t[2],t[3]+t[3]):6===t.length?s(t.split(/(?=..)/).join("")):s(t.substr(0,6).padEnd(6,"0"),t.substr(6,2)||null):s("000000","00")},i=e=>e.replace(/^\s*\w{3}a?\s*\(\s*|\s*\)$/g,"").split(/,\s*/),c=e=>{let r=i(e.startsWith("#")?n(e):e);for(let a in r)if(r[a])if(r[a].includes("%")){let l=r[a].replace("%","");e.includes("hsl")?r[a]=""+Math.round(l/100*(0===a?360:100)):r[a]=""+t(l)}else 3===a&&(r[a]=Math.round(e.includes("rgb")?num/255:num/100));else r[a]=0;return r},p=e=>{let[t,r,l,s]=Array.isArray(e)?e:c(e);return"#"+a(t)+a(r)+a(l)+(s>0?a(s):"")};R("@colou?r",(e,r,l="0",s="0",i="0",o="")=>(/#|rgba?|hsla?/i.test(l)?(l.includes("#")&&(l=n(l)),/rgba?|hsla?/.test(l)&&([l,s,i,o]=c(l))):[l,s,i,o]=c(`${r}(${l}, ${s}, ${i}, ${o})`),/#|hash|hex/i.test(r)?"#"+a(l)+a(s)+a(i)+(o?a(t(o)):""):/rgba?/i.test(r)?"rgba"===r?`rgba(${l}, ${s}, ${i}, ${o||o===0?100:''}%)`:`rgb(${l}, ${s}, ${i})`:/hsla?/i.test(r)?"hsla"===r?`${r}(${l%360}, ${s}%, ${i}%, ${o||o===0?100:''}%)`:`${r}(${l%360}, ${s}%, ${i}%)`:`${r.toLowerCase()}(${l} ${s} ${i}${o?" / "+o:""})`)),R("@colou?rpart",(e,t="",a="")=>{let l=t.toLowerCase(),s=a.toLowerCase(),n=c(s);return s.startsWith("#")||s.startsWith("rgb")?l.startsWith("r")?n[0]:l.startsWith("g")?n[1]:l.startsWith("b")?n[2]:l.startsWith("a")?n[3]:(r("func",["@colorpart",l," of color type rgb/rgba/#"]),s):s.startsWith("hsl")?l.startsWith("h")?n[0]:l.startsWith("s")?n[1]:l.startsWith("l")?n[2]:l.startsWith("a")?n[3]:(r("func",["@colorpart",l," of color type hsl/hsla"]),s):(r("func",["@colorpart",l," of unknown color type"]),s)}),R("@spin",(e,t,r)=>{let[a]=t.replace(/^hsla?\s*\(|\s*\)\s*$/g,"").split(/,\s*/),l=(E(a)+E(r||0))%360;return t.replace(a,l)});const h=(e,t,a)=>{if(!t)return r("func",["@colorblend",t,": color can not be empty"]),e||"";let l=e.match(/^[a-z]{3}a?|^#/).toString(),s=Math.abs(a.toString().includes("%")?a.replace("%","")/100:a);s=s>1?1:s;let[[n,i,o,$],[h,u,m,g]]=[c(e),c(t)],f=Math.floor(E(n)*(1-s)+E(h)*s),d=Math.floor(E(i)*(1-s)+E(u)*s),b=Math.floor(E(o)*(1-s)+E(m)*s),v=Math.floor(E($)*(1-s)+E(g)*s);return"rgba"===l?`rgba(${f}, ${d}, ${b}, ${v})`:"rgb"===l?`rgb(${f}, ${d}, ${b})`:"hsla"===l?`hsla(${f%360}, ${d/100}%, ${b/100}%, ${v})`:"hsl"===l?`hsla(${f%360}, ${d/100}%, ${b/100}%)`:"#"===l?p([f,d,b,v]):`${l}(${f}, ${d}, ${b})`},u=(e,t,r,a)=>{if(!t.includes("hsl"))return h(t,r,a||.5);let[l,s,n,i]=c(t),o=a.replace("%",""),p=E(s)-E(o),$=E(n)+E(o)*("shade"===e?-1:1),u="tone"===e?`${p}%, ${n}%`:`${s}%, ${$<0?0:$}%`;return`${t.match(/^hsla?/)}(${l%360}, ${u}${i?", "+i:""})`};R("@blend",(e,t,r,a=.5)=>h(t,r,a)),R("@tint",(e,t,r)=>u("tint",t,"#fff",r||.5)),R("@shade",(e,t,r)=>u("shade",t,"#000",r||.5)),R("@tone",(e,t,r)=>u("tone",t,"#808080",r||.5));const g=(e,t)=>{if(!e.startsWith("rgb")&&!e.startsWith("#"))return r("func",["@luma or @contrast","hsl",": only RGB values are allowed"]),e;let[a,l,s]=t?[...t]:c(e);const n=e=>e<=.03928?e/12.92:(e=>((e+.055)/1.055)**2.4)(e);return.2126*n(a/255)+.7152*n(l/255)+.0722*n(s/255)};R("@luma",(e,t)=>g(t)),R("@contrast",(e,t,r,a)=>g(t)<.5?r:a),R("@gr[ae]yscale",(e,t)=>{if(t.startsWith("hsl"))return t.replace(/^hsla?\s*\(\s*(\d+),\s*(\d+)/,"hsla($1, 0");let r=Math.round(255*g(t)),a=`rgb(${Array(3).fill(r).join(", ")})`;return t.startsWith("#")?p(a):a});const d=e=>{for(let t=0;t<m/10;t++)e=e.trim().replace(/(?:'(.+?)'|"(.+?)")+/,"$1$2").replace(/\bor\b/gi,"||").replace(/\band\b/gi,"&&").replace(/\bnot\b/gi,"!").replace(/(.+?)\bnor\b(.+)?/gi,"!($1) && !($2)").replace(/(.+?)\bnand\b(.+)?/gi,"!($1) || !($2)").replace(/(.+?)\bxor\b(.+)?/gi,"($1 && !($2)) || (!($1) && $2)").replace(/(.+?)\bxnor\b(.+)?/gi,"$1 == $2").replace(/(?!=)(!?)=(==)?(?!=)/g,"$1$2==");return e.match(/(<|<=|>|>=|==|!=|&|\||!)/)&&(e=eval(e)),["false","undefined","null","NaN",""].includes(e)&&(e=!1),e},v=e=>RE(l`([+-]?${b})\s*(?:${e})\s*([+-]?${b})`);R("@bitwise",(e,t)=>{let r=t.replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<");for(let e=0;e<m/10;e++)r=r.replace(RE(l`(?:~|!|not)\s*([+-]?${b})`),(e,t)=>eval("~"+E(t))).replace(v("or|\\|"),(e,t,r)=>eval(`(${E(t)}) | (${E(r)})`)).replace(v("nor"),(e,t,r)=>eval(`~ (${E(t)}) | (${E(r)})`)).replace(v("and|&"),(e,t,r)=>eval(`(${E(t)}) & (${E(r)})`)).replace(v("nand"),(e,t,r)=>eval(`~ (${E(t)}) & (${E(r)})`)).replace(v("xor"),(e,t,r)=>eval(`(${E(t)}) ^ (${E(r)})`)).replace(v("xnor"),(e,t,r)=>eval(`~ (${E(t)}) ^ (${E(r)})`));return r}),R("@boolean",(e,t)=>d(t)),R("@if",(e,t,r="",a="")=>d(t)?r:a),R("@breakpoint",(e,t="",r,a,l="")=>`@media (max-width: ${t}+0px) {\n ${r} {${a||""}}\n}\n@media (min-width: ${t||""}+1px) {\n${r} {${l}}\n}`,{nT:!0,nN:!0}),R("@prefix",(e,t,r)=>`-webkit-${t}: ${r}; -moz-${t}: ${r}; -ms-${t}: ${r}; -o-${t}: ${r}; ${t}: ${r};`,{nN:!0})}for(let e=0;o.indexOf("%")>-1&&e++<h;e++)o=o.replace(/([^{}]+?){[^{}]*?}[^{}]*?%[^{}]*?{/g,(e,t)=>t.includes("%")?e:e.replace(/%/g,t.trim()));for(let e=0;o.indexOf("&")>-1&&e++<h;e++)o=o.replace(/([^{}]+?){[^{}]*?}([^{}]*?&[^{}]*?{[^{}]*})+/g,(e,t)=>t.includes("&")?e:e.replace(/&/g,t.trim()+(t.includes("%")?"<":"")));for(let e=0;o.indexOf("<")>-1&&e++<h;e++)o=o.replace(/[>+~\s]\s*[^&%{}>+~\s<]+\s*</g,"");o=o.replace(/@endvar/g,"");let I=o.match(/\$[\[(](.+?)[\])]/g);if(I)for(let e of I){let t=e.replace(/\$[\[(](.*?)(\|.*)?[\])]/,"$1").trim();o=o.replace(e,"");let a=e.includes("$(")?"variable":"argument";r(`Instances of unparsed ${a} "${t}" have been removed from the output.`)}o=o.replace(/(\s*;)+/g,";").replace(/(?<!^ *) +/gm," ").replace(/(?<![1-9]+)(0\.\d+)(?=m|s)/,(e,t)=>1e3*NM(t)+"m").replace(/0mm/g,"cm").replace(/\.?0{10,}\d/g,"").replace(/((\d)\2{9,})\d/g,"$1").replace(/(\d+)([5-9])\2{10,}\d?(?=\D)/g,(e,t)=>NM(t)+1);for(let e in p)o=o.replace(RE(l`\/\*STATIC#${e}\*\/`,"g"),p[e].trim());for(let e in c)o=o.replace(RE(l`\/\*COMMENT#${e}\*\/`,"g"),"/*"+c[e]+"*/");if(e)return o.trim();{if(document.querySelectorAll(`[data-hash="${t(o)}"]`).length)break;let e=document.createElement("style");e.innerHTML="\n"+o.trimStart().trimEnd()+"\n",e.dataset.hash=t(o),e.dataset.source=n[a],(document.head||document.body).appendChild(e)}}}function a(e,t){try{fs.readFile(e,"utf8",(r,a)=>{if(r)throw`FSReadError: Input file ${e} not found.`;fs.writeFile(t,parseNovaSheets(a).replace(/\}/g,"}\n"),e=>{if(e)throw`FSWriteError: Output file ${t} is invalid.`})})}catch(e){}}String.prototype.trim=function(e){return this.replace(/^\s*(.+?)\s*$/,"$1").replace(/\s+/g,e?"":" ")};try{module.exports.parse=parseNovaSheets,module.exports.compile=a;const t=console.log,l=e=>process.argv[e+1]||"";let s=e=>l(1).startsWith("-")&&l(1).includes(e);if(s("-h"))r('Arguments:\n\n    novasheets [{-c, --compile}] <input file> [<output file>]\tCompile a NovaSheets file \n    novasheets {-p, --parse} "<input>"\t\t\t\tParse raw NovaSheets input from the command line \n    novasheets {-h, --help}\t\t\t\t\tDisplay this help message \n    novasheets {-v, --version}\t\t\t\t\tDisplay the current version of NovaSheets');else if(s("-v"))r("Current version: "+e);else if(s("-p"))t(parseNovaSheets(l(2)));else{let e=s("-c"),t=l(e?2:1),r=e?l(3):l(2)||t.replace(".nss",".css");a(t,r)}}catch(e){try{document.addEventListener("DOMctLoaded",parseNovaSheets()),a=void 0}catch(e){console.log("An unknown error has occurred. Stack trace: "+e)}}