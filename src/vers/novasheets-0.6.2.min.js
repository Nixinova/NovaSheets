#!/usr/bin/env node
const e="0.6.2";try{fs=require("fs")}catch{}function t(e,t=8){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t);return Math.abs(r).toString(16).substring(0,t).padStart(t,"0")}function r(e,t){return"func"==e?r(`Unknown value "${t[1]}" in built-in function ${t[0]}${t[2]}.`):console.warn("<NovaSheets>",e)}function parseNovaSheets(e){String.prototype.strim=function(){return this.replace(/^\s*(.+?)\s*$/,"$1").replace(/\s+/g," ")};const s=String.raw;try{window}catch{window={}}let l=[],n=[],c,i;if(e&&e.input)a(e.input,e.output);else if(e||Object.is(window,{}))l=[e.toString()],n="raw";else{try{c=document.querySelectorAll('link[rel="novasheet" i], link[rel="novasheets" i]'),i=document.querySelectorAll('[type="novasheet" i], [type="novasheets" i]')}catch{try{c=document.querySelectorAll('link[rel="novasheet"], link[rel="novasheets"]'),i=document.querySelectorAll('[type="novasheet"], [type="novasheets"]')}catch{}}let e={full:[],rel:[]};for(let t of c)e.full.push(t.href),e.rel.push(t.getAttribute("href"));for(let t in e.full)try{let r=new XMLHttpRequest;if(r.open("GET",e.full[t],!1),r.send(),404==r.status)throw 404;let a=r.responseText;l.push(a.toString()),n.push(e.rel[t])}catch{r(`File "${e.rel[t]}" cannot be accessed.`)}for(let e of i)l.push(e.innerHTML),n.push("inline")}window.randomHash=window.randomHash||t(Math.random().toString(),6);for(let a in l){l[a]=l[a].replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/(?<![a-z]+:)\n?\/\/.*$/gm,"").replace(/(?:@var.+?=.*$|@var\s*[^=]*(?=\n\s*@var\s.))(?!\n\s*@endvar)/gm,"$& @endvar").replace(/@(var|const|endvar)/g,"\n$&").replace(/@const\s*[A-Z_]+\s*(true|false|[0-9]+)|@endvar/g,"$&\n");let c=l[a].split("\n"),i="",o=[],p=[];for(let e in c)c[e]=c[e].replace(/[\r\n]/g," "),i+="\n"+c[e];i=i.replace(/\s*(?:@var.*?((?=@var)|@endvar)|@const\s*[A-Z_]+\s*(true|false|[0-9]+))/gms," ").replace(/\/\*(.+?)\*\//gs,(e,t)=>e.startsWith("/*[")&&e.endsWith("]*/")?e.replace(/^\/\*\[(.+)\]\*\/$/,"/*$1*/"):e.startsWith("/*/")||e.endsWith("/*/")?e:(o.indexOf(t)<0&&o.push(t),"/*COMMENT#"+o.indexOf(t)+"*/")).replace(/\/\*\/(.+?)\/\*\//gs,(e,t)=>(p.indexOf(t)<0&&p.push(t),"/*STATIC#"+p.indexOf(t)+"*/"));let u=[],$=50,h=5,f=10,g,m=!1;for(let e in c){let t;if(c[e].match(/^\s*@var\s/)){let t=c[e].replace(/^\s*@var\s/,"").split("="),r=c.slice(e),a;for(let e in r)if(r[e].match(/^\s*@endvar\s*$|^\s*@var\s/)&&0!=e){a=e;break}let l=t[0].trim().split("|")[0].trim();const n=t.slice(1).join("=")||"",i=r.slice(1,a).join("\n"),o=new RegExp(s`\$\(\s*${l}\s*\)`,"g");let p=(n+i).trim().replace(o,u[l]||"");u[l]=p}else if(c[e].match(t=/^\s*@const\s+/)){let[r,a]=c[e].replace(t,"").split(/\s+/);switch(r.toUpperCase()){case"MAX_RECURSION":$=parseInt(a);break;case"MAX_MATH_RECURSION":h=parseInt(a);break;case"MAX_ARGUMENTS":f=parseInt(a);break;case"DECIMAL_PLACES":g="false"!==a&&a;break;case"KEEP_NAN":m="0"!==a&&"false"!==a}}}const d=s`(?:[0-9]*\.?[0-9]+)`,b=s`(?:0x[0-9a-f]*\.?[0-9a-f]+|0b[01]*\.?[01]+|0o[0-7]*\.?[0-7]+|${d})`,v=s`(?:\(\s*${b}\s*\)|${b})`,x=s`(?:\(\s*${b}\s*\)|${b})\s*[a-z]*[-+*^/e\s]+(?:\(\s*${b}\s*\)|${b})\s*[a-z]*`,M=s`\s*(?:em|rem|en|ex|px|pt|pc|cm|mm|m(?![ms])|ft|in|s|ms)`,w=e=>s`(?:[-e^*/+\s${e?"()":""}]+(?=\d|\.))`,E=e=>{const t=s`\(\s*`,r=s`\s*\)`,a=`${b}${M}?`,l=`(?:${t}${a}${r}|${a})`,n=e.op||w(e.b);let c=s`(?:(?:${l}\s*${n}\s*)+(?:${a}))`;return s`\(${c}\)|${c}`},N=e=>m?Number(e):isNaN(Number(e))?"":Number(e),y=()=>{for(let e=0;e<h&&i.match(RegExp(x));e++)i=i.replace(RegExp(E({}),"g"),e=>{let t=!e.match(/[-+e^*/]/),r=e.match(RegExp(s`${M}\s-?${b}`));if(t||r)return e;let a=e.match(RegExp(M,"g"))||[],l=a[a.length-1]||"",n=e.replace(RegExp(`(${d})s*(${M})`,"g"),(e,t,r)=>{switch(r){case"mm":case"ms":return l=r[1],N(t)/1e3;case"cm":return l="m",N(t)/100;case"in":return l="m",.0254*N(t);case"ft":return l="m",.3048*N(t);default:return e}}).replace(RegExp(M,"g"),"").replace(/\d\s*e\s*\d/g,"$&".replace(/\s/g,"")).replace(/--/g,"- -").replace(/\^/g,"**");try{return eval(n)+l}catch{return n+l}})},S=e=>e.replace(/[.*+?^/${}()|[\]\\]/g,"\\$&"),R=(e,t)=>{let r=!e||e===1/0||Number.isNaN(e);return r&&m?"NaN":r&&!m?t||0:e},A=(e,t,{nonest:r,notrim:a,allargs:l}={})=>{y();let n=RegExp(s`\$\(\s*${e}\b`),c=i.match(n);if(!c)return;let o,p=c?i.indexOf(c[0]):-1,u=i.substr(p),$="",h=0;for(let e=0;e<u.length&&($+=u[e],h>0&&(o=!0),"("===u[e]&&h++,")"===u[e]&&h--,!o||0!==h);e++)if(e==u.length-1&&h>0)return;if(!$.trim()||r&&$.match(/.+\$\(/))return;let g=s`^\$\(${a?"|":s`\s*|\s*`}\)$`,m=a?"|":/\s*\|\s*/,d=$.replace(RegExp(g,"g"),"").split(m);for(let e=0;e<f;e++)null==d[e]&&(d[e]="");if(!l)for(let e=f;e>0;e--)if(d[e]){d=d.slice(0,e+1);break}d[0]=$,i=i.replace($,t(...d))};let C=0,I,O;for(;(i.indexOf("$(")>-1||C<1)&&C++<$&&I!==i;){I=i;for(let e in u)A(e,(t,...r)=>{let a=u[e];for(let e in r){if(!r[e])continue;let t=r[e].split("="),l=t[1]?t[0].strim():+e+1,n=t[1]?t[1].strim():t[0].strim();a=a.replace(RegExp(s`\$\[${l}[^\]]*\]`,"g"),n)}return a=a.replace(/\$\[.*?(?:\|([^\]]*))?\]/g,"$1"),a});for(let e=0;i.indexOf("%")>-1&&e++<$;e++)i=i.replace(/([^{}|()]+?){[^{}]*?}[^{}]*?%[^{}]*?{/g,(e,t)=>t.includes("%")?e:e.replace(/(?<!\d)%/g,t.strim()));for(let e=0;i.indexOf("&")>-1&&e++<$;e++)i=i.replace(/([^{}|()]+?){[^{}]*?}([^{}]*?&[^{}]*?{[^{}]*})+/g,(e,t)=>t.includes("&")?e:e.replace(/&/g,t.strim()+(t.match(/(?<!\d)%/)?"<":"")));for(let e=0;i.indexOf("<")>-1&&e++<$;e++)i=i.replace(/[>+~\s]\s*[^&%{}>+~\s<]+\s*</g,"");A("@each",(e,t="",r="",a="",...s)=>{s=s.join("|");let[l,n,c,i]=s?[t,r,a,s]:a?[t,r,r,a]:[t,",",",",r];[l,n,c,i]=[l.strim(),n.strim(),c,i.strim()];let o=l.split(n),p=[];for(let e in o){let t=i.replace(/\$i/gi,Number(e)+1).replace(/\$v\[([0-9]+)([-+*/][0-9]+)?\]/g,(e,t,r)=>o[eval(Number(t-1)+(r||0))]).replace(/.?\s*undefined/g,"").replace(/\$v/gi,o[e]);p.push(t)}return p.join(c)},{notrim:!0}),A("@repeat",(e,t,...r)=>{let a="";for(let e=0;e<Number(t);e++)a+=r.join("|").replace(/\$i/gi,Number(e)+1);return a}),A("@e",e=>Math.E),A("@pi",e=>Math.PI),A("@mod",(e,t,...r)=>R(t%r,e)),A("@sin",(e,t)=>R(Math.sin(t),e)),A("@asin",(e,t)=>R(Math.asin(t),e)),A("@cos",(e,t)=>R(Math.cos(t),e)),A("@acos",(e,t)=>R(Math.acos(t),e)),A("@tan",(e,t)=>R(Math.tan(t),e)),A("@atan",(e,t)=>R(Math.atan(t),e)),A("@abs",(e,t)=>R(Math.abs(t),e)),A("@floor",(e,t)=>R(Math.floor(t),e)),A("@ceil",(e,t)=>R(Math.ceil(t),e)),A("@percent",(e,t)=>R(100*N(t)+"%",e)),A("@log",(e,t,r)=>R(Math.log(r)/(t?Math.log(t):1),e)),A("@root",(e,t,r)=>R(Math.pow(r||t,1/(r?t:2)),e)),A("@round",(e,t,r)=>{let a=N(t)+Number.EPSILON,s=Math.pow(10,r||0);return R(Math.round(a*s)/s,e)}),A("@(?:max|min)",(e,...t)=>{let r=[];for(let e of t)e&&r.push(e);let a=e.includes("@min")?Math.min(...r):Math.max(...r);return R(a,e)}),A("@clamp",(e,t,r,a)=>{let s=Number(t),l=Number(r),n=Number(a);return n<l&&([l,n]=[n,l]),R(s<=l?l:s>=n?n:s,e)}),A("@degrees",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RegExp(d),"")];if("grad"===a)return.9*r;let s=r/Math.PI*180;return R(s,e)}),A("@radians",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RegExp(d),"")];if("grad"===a)return r*Math.PI/200;let s=r*Math.PI/180;return R(s,e)}),A("@gradians",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RegExp(d),"")];return"rad"===a?r/Math.PI*200:R(r/.9,e)}),A("@lowercase",(e,t)=>t.toLowerCase()),A("@uppercase",(e,t)=>t.toUpperCase()),A("@titlecase",(e,t)=>t.replace(/\b\w/g,e=>e.toUpperCase())),A("@camelcase",(e,t)=>t.replace(/\s\w/g,e=>e.toUpperCase())),A("@capitali[sz]e",(e,t)=>t[0].toUpperCase()+t.substr(1)),A("@extract",(e,t,r,a)=>t.split(a?r:",")[N(a||r)-1]||""),A("@encode",(e,t)=>encodeURIComponent(t)),A("@length",(e,t)=>t.strim().length),A("@replace",(e,...t)=>{t.length<3&&(t=[t[0],t[1]||"",t[2]||""]);let r=(t=t.slice(0,t.indexOf("")<=3?3:t.indexOf("")))[0].strim(),a=t.slice(1,-1).join("|").strim(),s=t.slice(-1)[0].strim(),l=a.startsWith("/");if(l){let e=a.strim().match(/\/(.+?)\/([gimusy]*)/).slice(1);a=RegExp(e[0],e[1]||"s")}return r.replace(l?a:RegExp(S(a),"g"),s)},{notrim:!0,allargs:!0});const e=e=>Math.floor(Number(e)/255*100),t=e=>Math.ceil(255*Number(e.replace("%",""))/100),a=e=>Number(e).toString(16).padStart(2,"0"),l=(t,r)=>{let a=parseInt(t.replace(/#?(.{0,6})(..)?$/,"$1"),16),s=a>>16&255,l=a>>8&255,n=255&a,c=r&&e(parseInt(r,16));return null!=c?`rgba(${s}, ${l}, ${n}, ${c})`:`rgb(${s}, ${l}, ${n})`},n=e=>{let t=e.replace("#","");switch(t.length){case 0:return l("000000","00");case 1:return l(t.repeat(6));case 2:return l(t[0].repeat(6),t[1].repeat(2));case 3:return l(t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);case 4:return l(t[0]+t[0]+t[1]+t[1]+t[2]+t[2],t[3]+t[3]);default:return l(t.substr(0,6).padEnd(6,"0"),t.substr(6,2)||null)}},c=e=>e.replace(/^\s*\w{3}a?\s*\(\s*|\s*\)$/g,"").split(/,\s*/),o=e=>{let r=c(e.startsWith("#")?n(e):e);for(let a in r)if(r[a])if(r[a].includes("%")){let s=r[a].replace("%","");e.includes("hsl")?r[a]=""+Math.round(s/100*(0===a?360:100)):r[a]=""+t(s)}else 3===a&&(r[a]=Math.round(e.includes("rgb")?num/255:num/100));else r[a]=0;return r},p=e=>{let[t,r,s,l]=Array.isArray(e)?e:o(e);return"#"+a(t)+a(r)+a(s)+(l>0?a(l):"")};A("@colou?r",(e,r,s="0",l="0",c="0",i="")=>{switch(/#|rgba?|hsla?/i.test(s)?(s.includes("#")&&(s=n(s)),/rgba?|hsla?/.test(s)&&([s,l,c,i]=o(s))):[s,l,c,i]=o(`${r}(${s}, ${l}, ${c}, ${i})`),r=r.toLowerCase()){case"#":case"hash":case"hex":case"hexadecimal":return"#"+a(s)+a(l)+a(c)+(i?a(t(i)):"");case"rgb":return`rgb(${s}, ${l}, ${c})`;case"rgba":return`rgba(${s}, ${l}, ${c}, ${i||0===i?100:""}%)`;case"hsl":return`hsl(${s%360}, ${l}%, ${c}%)`;case"hsla":return`hsla(${s%360}, ${l}%, ${c}%, ${i||0===i?100:""}%)`;default:return`${r}(${s} ${l} ${c}${i?" / "+i:""})`}}),A("@colou?rpart",(e,t="",a="")=>{let s=t.toLowerCase(),l=a.toLowerCase(),n=o(l);if(l.startsWith("#")||l.startsWith("rgb"))switch(s[0]){case"r":return n[0];case"g":return n[1];case"b":return n[2];case"a":return n[3];default:r("func",["@colorpart",s," of color type rgb/rgba/#"])}else{if(!l.startsWith("hsl"))return r("func",["@colorpart",s," of unknown color type"]),l;switch(s[0]){case"h":return n[0];case"s":return n[1];case"l":return n[2];case"a":return n[3];default:r("func",["@colorpart",s," of color type hsl/hsla"])}}}),A("@spin",(e,t,r)=>{let[a]=t.replace(/^hsla?\s*\(|\s*\)\s*$/g,"").split(/,\s*/),s=(N(a)+N(r||0))%360;return t.replace(a,s)});const h=(e,t,a)=>{if(!t)return r("func",["@colorblend",t,": color can not be empty"]),e||"";let s=e.match(/^[a-z]{3}a?|^#/).toString(),l=Math.abs(a.toString().includes("%")?a.replace("%","")/100:a);l=l>1?1:l;let[[n,c,i,u],[$,h,f,g]]=[o(e),o(t)],m=Math.floor(N(n)*(1-l)+N($)*l),d=Math.floor(N(c)*(1-l)+N(h)*l),b=Math.floor(N(i)*(1-l)+N(f)*l),v=Math.floor(N(u)*(1-l)+N(g)*l);switch(s){case"rgba":return`rgba(${m}, ${d}, ${b}, ${v})`;case"rgb":return`rgb(${m}, ${d}, ${b})`;case"hsla":return`hsla(${m%360}, ${d/100}%, ${b/100}%, ${v})`;case"hsl":return`hsla(${m%360}, ${d/100}%, ${b/100}%)`;case"#":return p([m,d,b,v])}},g=(e,t,r,a)=>{if(!t.includes("hsl"))return h(t,r,a||.5);let[s,l,n,c]=o(t),i=a.replace("%",""),p=N(l)-N(i),u=N(n)+N(i)*("shade"===e?-1:1),$="tone"===e?`${p}%, ${n}%`:`${l}%, ${u<0?0:u}%`;return`${t.match(/^hsla?/)}(${s%360}, ${$}${c?", "+c:""})`};A("@blend",(e,t,r,a=.5)=>h(t,r,a)),A("@tint",(e,t,r)=>g("tint",t,"#fff",r||.5)),A("@shade",(e,t,r)=>g("shade",t,"#000",r||.5)),A("@tone",(e,t,r)=>g("tone",t,"#808080",r||.5));const m=(e,t)=>{if(!e.startsWith("rgb")&&!e.startsWith("#"))return r("func",["@luma or @contrast","hsl",": only RGB values are allowed"]),e;let[a,s,l]=t?[...t]:o(e);const n=e=>e<=.03928?e/12.92:(e=>((e+.055)/1.055)**2.4)(e);return.2126*n(a/255)+.7152*n(s/255)+.0722*n(l/255)};A("@luma",(e,t)=>m(t)),A("@contrast",(e,t,r="",a="")=>m(t)<.5?r:a),A("@gr[ae]yscale",(e,t)=>{if(t.startsWith("hsl"))return t.replace(/^(hsla?)\s*\(\s*(\d+),\s*(\d+)/,"$1($2, 0");let r=Math.round(255*m(t)),a=`rgb(${Array(3).fill(r).join(", ")})`;return t.startsWith("#")?p(a):a});const b=e=>{for(let t=0;t<f/10;t++)e=e.strim().replace(/(?:'(.+?)'|"(.+?)")+/,"$1$2").replace(/\bor\b/gi,"||").replace(/\band\b/gi,"&&").replace(/\bnot\b/gi,"!").replace(/(.+?)\bnor\b(.+)?/gi,"!($1) && !($2)").replace(/(.+?)\bnand\b(.+)?/gi,"!($1) || !($2)").replace(/(.+?)\bxor\b(.+)?/gi,"($1 && !($2)) || (!($1) && $2)").replace(/(.+?)\bxnor\b(.+)?/gi,"$1 == $2").replace(/(?!=)(!?)=(==)?(?!=)/g,"$1$2==");return e.match(/(<|<=|>|>=|==|!=|&|\||!)/)&&(e=eval(e)),["false","undefined","null","NaN",""].includes(e)&&(e=!1),e},x=e=>RegExp(s`([+-]?${v})\s*(?:${e})\s*([+-]?${v})`);A("@bitwise",(e,t)=>{let r=t.replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<");for(let e=0;e<f/10;e++)r=r.replace(RegExp(s`(?:~|!|not)\s*([+-]?${v})`),(e,t)=>eval("~"+N(t))).replace(x("or|\\|"),(e,t,r)=>eval(`(${N(t)}) | (${N(r)})`)).replace(x("nor"),(e,t,r)=>eval(`~ (${N(t)}) | (${N(r)})`)).replace(x("and|&"),(e,t,r)=>eval(`(${N(t)}) & (${N(r)})`)).replace(x("nand"),(e,t,r)=>eval(`~ (${N(t)}) & (${N(r)})`)).replace(x("xor"),(e,t,r)=>eval(`(${N(t)}) ^ (${N(r)})`)).replace(x("xnor"),(e,t,r)=>eval(`~ (${N(t)}) ^ (${N(r)})`));return r}),A("@boolean",(e,t)=>b(t)),A("@if",(e,t,r="",a="")=>b(t)?r:a),A("@breakpoint",(e,t=0,r="",a="",s="")=>{if(!t)return e;const l=(e,t,r)=>`@media (${e}-width: ${t}+${"max"===e?0:1}px) { ${r}}`;let n=(r+a).includes("{"),c=n?[r,a]:[`${r} {${a}} `,`${r} {${s}} `],i=(n?r:a).trim()?l("max",t,c[0]):"",o=(n?a:s).trim()?l("min",t,c[1]):"";return i+(i&&o?"\n":"")+o},{notrim:!0}),A("@prefix",(e,t,r)=>`-webkit-${t}: ${r}; -moz-${t}: ${r}; -ms-${t}: ${r}; -o-${t}: ${r}; ${t}: ${r};`,{nonest:!0})}if(i=i.replace(/@endvar/g,""),O)for(let e of O){let t=e.replace(/\$[\[(](.*?)(\|.*)?[\])]/,"$1").strim();i=i.replace(e,"");let a=e.includes("$(")?"variable":"argument";r(`Instances of unparsed ${a} "${t}" have been removed from the output.`)}i=i.replace(/(\s*;)+/g,";").replace(/(?<!^ *) +/gm," ").replace(/(?<![1-9]+)(0\.\d+)(?=m|s)/,(e,t)=>1e3*Number(t)+"m").replace(/0mm/g,"cm").replace(/\.?0{10,}\d/g,"").replace(/((\d)\2{9,})\d/g,"$1").replace(/(\d+)([5-9])\2{10,}\d?(?=\D)/g,(e,t)=>Number(t)+1).replace(RegExp(s`((\d)\.\d{0,${g||""}})(\d?)\d*`),(e,t,r,a)=>"0"===g?a.match(/[5-9]$/)?parseInt(r)+1:r:a.match(/[5-9]$/)?t.replace(/.$/,"")+(parseInt(t.substr(-1))+1).toString():t);for(let e in p)i=i.replace(RegExp(s`\/\*STATIC#${e}\*\/`,"g"),p[e].strim());for(let e in o)i=i.replace(RegExp(s`\/\*COMMENT#${e}\*\/`,"g"),"/*"+o[e]+"*/");if(e)return i.strim();{if(document.querySelectorAll(`[data-hash="${t(i)}"]`).length)break;let e=document.createElement("style");e.innerHTML="\n"+i.trimStart().trimEnd()+"\n",e.dataset.hash=t(i),e.dataset.source=n[a],(document.head||document.body).appendChild(e)}}String.prototype.strim=void 0}function a(e,t){try{fs.readFile(e,"utf8",(r,a)=>{if(r)throw`FSReadError: Input file ${e} not found.`;fs.writeFile(t,parseNovaSheets(a).replace(/\}/g,"}\n"),e=>{if(e)throw`FSWriteError: Output file ${t} is invalid.`})})}catch(e){}}try{module.exports.parse=parseNovaSheets,module.exports.compile=a;const t=e=>process.argv[e+1]||"";let s=e=>t(1).startsWith("-")&&t(1).includes(e);if(s("-h"))r('Arguments:\n\n    novasheets [{-c, --compile}] <input file> [<output file>]\tCompile a NovaSheets file \n    novasheets {-p, --parse} "<input>"\t\t\t\tParse raw NovaSheets input from the command line \n    novasheets {-h, --help}\t\t\t\t\tDisplay this help message \n    novasheets {-v, --version}\t\t\t\t\tDisplay the current version of NovaSheets         ');else if(s("-v"))r("Current version: "+e);else if(s("-p"))console.log(parseNovaSheets(t(2)));else if(t(1)){let e=s("-c"),r=t(e?2:1),l=e?t(3):t(2)||r.replace(".nss",".css");a(r,l)}}catch{try{document.addEventListener("DOMContentLoaded",parseNovaSheets()),a=void 0}catch(e){console.log("An unknown error has occurred. Stack trace: "+e)}}