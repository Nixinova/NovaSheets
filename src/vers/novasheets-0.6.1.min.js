#!/usr/bin/env node
const e="0.6.1";try{fs=require("fs")}catch(e){}function t(e,t=8){let r=0;for(let t=0;t<e.length;t++)r=(r<<5)-r+e.charCodeAt(t);return Math.abs(r).toString(16).substring(0,t).padStart(t,"0")}function r(e,t){return"func"==e?r(`Unknown value "${t[1]}" in built-in function ${t[0]}${t[2]}.`):console.warn("<NovaSheets>",e)}function parseNovaSheets(e){const s=String.raw;try{window}catch(e){window={}}let n=[],l=[],c,i;if(e&&e.input)a(e.input,e.output);else if(e||Object.is(window,{}))n=[e.toString()],l="raw";else{try{c=document.querySelectorAll('link[rel="novasheet" i], link[rel="novasheets" i]'),i=document.querySelectorAll('[type="novasheet" i], [type="novasheets" i]')}catch(e){try{c=document.querySelectorAll('link[rel="novasheet"], link[rel="novasheets"]'),i=document.querySelectorAll('[type="novasheet"], [type="novasheets"]')}catch(e){}}let e={full:[],rel:[]};for(let t of c)e.full.push(t.href),e.rel.push(t.getAttribute("href"));for(let t in e.full)try{let r=new XMLHttpRequest;if(r.open("GET",e.full[t],!1),r.send(),404==r.status)throw 404;let a=r.responseText;n.push(a.toString()),l.push(e.rel[t])}catch(a){r(`File "${e.rel[t]}" cannot be accessed.`)}for(let e of i)n.push(e.innerHTML),l.push("inline")}window.randomHash=window.randomHash||t(Math.random().toString(),6);for(let a in n){n[a]=n[a].replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/(?<![a-z]+:)\n?\/\/.*$/gm,"").replace(/(?:@var.+?=.*$|@var\s*[^=]*(?=\n\s*@var\s.))(?!\n\s*@endvar)/gm,"$& @endvar").replace(/@(var|const|endvar)/g,"\n$&").replace(/@const\s*[A-Z_]+\s*(true|false|[0-9]+)|@endvar/g,"$&\n");let c=n[a].split("\n"),i="",o=[],u=[];for(let e in c)c[e]=c[e].replace(/[\r\n]/g," "),i+="\n"+c[e];i=i.replace(/\s*(?:@var.*?((?=@var)|@endvar)|@const\s*[A-Z_]+\s*(true|false|[0-9]+))/gms," ").replace(/\/\*(.+?)\*\//gs,(e,t)=>e.startsWith("/*[")&&e.endsWith("]*/")?e.replace(/^\/\*\[(.+)\]\*\/$/,"/*$1*/"):e.startsWith("/*/")||e.endsWith("/*/")?e:(o.indexOf(t)<0&&o.push(t),"/*COMMENT#"+o.indexOf(t)+"*/")).replace(/\/\*\/(.+?)\/\*\//gs,(e,t)=>(u.indexOf(t)<0&&u.push(t),"/*STATIC#"+u.indexOf(t)+"*/"));let p=[],$=50,h=5,m=10,f=!1;for(let e in c)if(c[e].match(/^\s*@var\s/)){let t=c[e].replace(/^\s*@var\s/,"").split("="),r=c.slice(e),a;for(let e in r)if(r[e].match(/^\s*@endvar\s*$|^\s*@var\s/)&&0!=e){a=e;break}let s=t[0].trim(),n=(t.slice(1).join("=")||"")+r.slice(1,a).join(" ");p.push({name:s.split("|")[0].trim(),content:n.trim()})}else c[e].match(/^\s*@const\s*MAX_RECURSION\s/)?$=parseInt(c[e].split("MAX_RECURSION")[1]):c[e].match(/^\s*@const\s*MAX_MATH_RECURSION\s/)?h=parseInt(c[e].split("MAX_MATH_RECURSION")[1]):c[e].match(/^\s*@const\s*MAX_ARGUMENTS\s/)?m=parseInt(c[e].split("MAX_ARGUMENTS")[1]):c[e].match(/^\s*@const\s*KEEP_NAN\s/)&&(f=!["0","false"].includes(c[e].split("KEEP_NAN")[1].trim()));const g=s`(?:[0-9]*\.?[0-9]+)`,d=s`(?:0x[0-9a-f]*\.?[0-9a-f]+|0b[01]*\.?[01]+|0o[0-7]*\.?[0-7]+|${g})`,b=s`(?:\(\s*${d}\s*\)|${d})`,v=s`(?:\(\s*${d}\s*\)|${d})\s*[a-z]*[-+*^/e\s]+(?:\(\s*${d}\s*\)|${d})\s*[a-z]*`,M=s`\s*(?:em|rem|en|ex|px|pt|pc|cm|mm|m(?![ms])|ft|in|s|ms)`,x=e=>s`(?:[-e^*/+\s${e?"()":""}]+(?=\d|\.))`,N=e=>{const t=s`\(\s*`,r=s`\s*\)`,a=`${d}${M}?`,n=`(?:${t}${a}${r}|${a})`,l=e.op||x(e.b);let c=s`(?:(?:${n}\s*${l}\s*)+(?:${a}))`;return s`\(${c}\)|${c}`},E=e=>f?Number(e):isNaN(Number(e))?"":Number(e),w=()=>{for(let e=0;e<h&&i.match(RegExp(v));e++)i=i.replace(RegExp(N({}),"g"),e=>{let t=!e.match(/[-+e^*/]/),r=e.match(RegExp(s`${M}\s-?${d}`));if(t||r)return e;let a=e.match(RegExp(M,"g"))||[],n=a[a.length-1]||"",l=e.replace(RegExp(`(${g})s*(${M})`,"g"),(e,t,r)=>{switch(r){case"mm":case"ms":return n=r[1],E(t)/1e3;case"cm":return n="m",E(t)/100;case"in":return n="m",.0254*E(t);case"ft":return n="m",.3048*E(t);default:return e}}).replace(RegExp(M,"g"),"").replace(/\d\s*e\s*\d/g,"$&".replace(/\s/g,"")).replace(/--/g,"- -").replace(/\^/g,"**");try{return eval(l)+n}catch(e){return l+n}})},y=e=>e.replace(/[.*+?^/${}()|[\]\\]/g,"\\$&"),S=(e,t)=>{let r=!e||e===1/0||Number.isNaN(e);return r&&f?"NaN":r&&!f?t||0:e},R=(e,t,r={})=>{w();let a=RegExp(s`\$\(\s*${e}\b`),n=i.match(a);if(!n)return;let l,c=n?i.indexOf(n[0]):-1,o=i.substr(c),u="",p=0;for(let e=0;e<o.length&&(u+=o[e],p>0&&(l=!0),"("===o[e]&&p++,")"===o[e]&&p--,!l||0!==p);e++)if(e==o.length-1&&p>0)return;if(!u.trim("force")||r.nonest&&u.match(/.+\$\(/))return;let $=s`^\$\(${r.notrim?"|":s`\s*|\s*`}\)$`,h=r.notrim?"|":/\s*\|\s*/,f=u.replace(RegExp($,"g"),"").split(h);for(let e=0;e<m;e++)f[e]||(f[e]="");for(let e=m;e>0;e--)if(f[e]){f=f.slice(0,e+1);break}f[0]=u,i=i.replace(u,t(...f))};let A=0,I;for(;(i.indexOf("$(")>-1||A<1)&&A++<$&&I!==i;){I=i;for(let e in p)R(p[e].name,(t,...r)=>{let a=p[e].content;for(let e in r){if(!r[e])continue;let t=r[e].split("="),n=t[1]?t[0].trim():+e+1,l=t[1]?t[1].trim():t[0].trim();a=a.replace(RegExp(s`\$\[${n}[^\]]*\]`,"g"),l)}return a=a.replace(/\$\[.*?(?:\|([^\]]*))?\]/g,"$1"),a});R("@each",(e,t,r,a,...s)=>{let n=[],l=t.trim().split(r.trim());for(let e in l){let t=s.join("|").replace(/\$i/gi,Number(e)+1).replace(/\$v\[([0-9]+)([-+*/][0-9]+)?\]/g,(e,t,r)=>l[eval(Number(t-1)+(r||0))]).replace(/.?\s*undefined/g,"").replace(/\$v/gi,l[e]);n.push(t)}return n.join(a)},{notrim:!0}),R("@repeat",(_,t,...r)=>{let a="";for(let e=0;e<Number(t);e++)a+=r.join("|").replace(/\$i/gi,Number(e)+1);return a},{notrim:!0}),R("@e",E=>Math.E),R("@pi",_=>Math.PI),R("@mod",(e,t,...r)=>S(t%r,e)),R("@sin",(e,t)=>S(Math.sin(t),e)),R("@asin",(e,t)=>S(Math.asin(t),e)),R("@cos",(e,t)=>S(Math.cos(t),e)),R("@acos",(e,t)=>S(Math.acos(t),e)),R("@tan",(e,t)=>S(Math.tan(t),e)),R("@atan",(e,t)=>S(Math.atan(t),e)),R("@abs",(e,t)=>S(Math.abs(t),e)),R("@floor",(e,t)=>S(Math.floor(t),e)),R("@ceil",(e,t)=>S(Math.ceil(t),e)),R("@percent",(e,t)=>S(100*E(t)+"%",e)),R("@log",(e,t,r)=>S(Math.log(r)/(t?Math.log(t):1),e)),R("@root",(e,t,r)=>S(Math.pow(r||t,1/(r?t:2)),e)),R("@round",(e,t,r)=>{let a=E(t)+Number.EPSILON,s=Math.pow(10,r||0);return S(Math.round(a*s)/s,e)}),R("@(?:max|min)",(e,...t)=>{let r=[];for(let e of t)e&&r.push(e);let a=e.includes("@min")?Math.min(...r):Math.max(...r);return S(a,e)}),R("@clamp",(e,t,r,a)=>{let s=Number(t),n=Number(r),l=Number(a);return l<n&&([n,l]=[l,n]),S(s<=n?n:s>=l?l:s,e)}),R("@degrees",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RegExp(g),"")];if("grad"===a)return.9*r;let s=r/Math.PI*180;return S(s,e)}),R("@radians",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RegExp(g),"")];if("grad"===a)return r*Math.PI/200;let s=r*Math.PI/180;return S(s,e)}),R("@gradians",(e,t)=>{let[r,a]=[t.replace(/[a-z]+/,""),t.replace(RegExp(g),"")];return"rad"===a?r/Math.PI*200:S(r/.9,e)}),R("@extract",(_,t,r,a)=>t.split(r)[E(a)-1]||""),R("@encode",(e,t)=>encodeURIComponent(t)),R("@length",(e,t)=>t.trim().length),R("@replace",(x,...t)=>{let r=t[0].trim(),a=t.slice(1,-1).join("|").trim()||" ",s=t.slice(-1)[0].trim(),n=a.startsWith("/");if(n){let e=a.trim().match(/\/(.+?)\/([gimusy]*)/).slice(1);a=RegExp(e[0],e[1]||"s")}return r.replace(n?a:RegExp(y(a),"g"),s)},{notrim:!0});const e=e=>Math.floor(Number(e)/255*100),t=e=>Math.ceil(255*Number(e.replace("%",""))/100),a=e=>Number(e).toString(16).padStart(2,"0"),n=(t,r)=>{let a=parseInt(t.replace(/#?(.{0,6})(..)?$/,"$1"),16),s=a>>16&255,n=a>>8&255,l=255&a,c=r&&e(parseInt(r,16));return null!=c?`rgba(${s}, ${n}, ${l}, ${c})`:`rgb(${s}, ${n}, ${l})`},l=e=>{let t=e.replace("#","");switch(t.length){case 0:return n("000000","00");case 1:return n(t.repeat(6));case 2:return n(t[0].repeat(6),t[1].repeat(2));case 3:return n(t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);case 4:return n(t[0]+t[0]+t[1]+t[1]+t[2]+t[2],t[3]+t[3]);default:return n(t.substr(0,6).padEnd(6,"0"),t.substr(6,2)||null)}},c=e=>e.replace(/^\s*\w{3}a?\s*\(\s*|\s*\)$/g,"").split(/,\s*/),o=e=>{let r=c(e.startsWith("#")?l(e):e);for(let a in r)if(r[a])if(r[a].includes("%")){let s=r[a].replace("%","");e.includes("hsl")?r[a]=""+Math.round(s/100*(0===a?360:100)):r[a]=""+t(s)}else 3===a&&(r[a]=Math.round(e.includes("rgb")?num/255:num/100));else r[a]=0;return r},u=e=>{let[t,r,s,n]=Array.isArray(e)?e:o(e);return"#"+a(t)+a(r)+a(s)+(n>0?a(n):"")};R("@colou?r",(e,r,s="0",n="0",c="0",i="")=>{switch(/#|rgba?|hsla?/i.test(s)?(s.includes("#")&&(s=l(s)),/rgba?|hsla?/.test(s)&&([s,n,c,i]=o(s))):[s,n,c,i]=o(`${r}(${s}, ${n}, ${c}, ${i})`),r=r.toLowerCase()){case"#":case"hash":case"hex":case"hexadecimal":return"#"+a(s)+a(n)+a(c)+(i?a(t(i)):"");case"rgb":return`rgb(${s}, ${n}, ${c})`;case"rgba":return`rgba(${s}, ${n}, ${c}, ${i||0===i?100:""}%)`;case"hsl":return`hsl(${s%360}, ${n}%, ${c}%)`;case"hsla":return`hsla(${s%360}, ${n}%, ${c}%, ${i||0===i?100:""}%)`;default:return`${r}(${s} ${n} ${c}${i?" / "+i:""})`}}),R("@colou?rpart",(e,t="",a="")=>{let s=t.toLowerCase(),n=a.toLowerCase(),l=o(n);if(n.startsWith("#")||n.startsWith("rgb"))switch(s[0]){case"r":return l[0];case"g":return l[1];case"b":return l[2];case"a":return l[3];default:r("func",["@colorpart",s," of color type rgb/rgba/#"])}else{if(!n.startsWith("hsl"))return r("func",["@colorpart",s," of unknown color type"]),n;switch(s[0]){case"h":return l[0];case"s":return l[1];case"l":return l[2];case"a":return l[3];default:r("func",["@colorpart",s," of color type hsl/hsla"])}}}),R("@spin",(e,t,r)=>{let[a]=t.replace(/^hsla?\s*\(|\s*\)\s*$/g,"").split(/,\s*/),s=(E(a)+E(r||0))%360;return t.replace(a,s)});const $=(e,t,a)=>{if(!t)return r("func",["@colorblend",t,": color can not be empty"]),e||"";let s=e.match(/^[a-z]{3}a?|^#/).toString(),n=Math.abs(a.toString().includes("%")?a.replace("%","")/100:a);n=n>1?1:n;let[[l,c,i,p],[$,h,m,f]]=[o(e),o(t)],g=Math.floor(E(l)*(1-n)+E($)*n),d=Math.floor(E(c)*(1-n)+E(h)*n),b=Math.floor(E(i)*(1-n)+E(m)*n),v=Math.floor(E(p)*(1-n)+E(f)*n);switch(s){case"rgba":return`rgba(${g}, ${d}, ${b}, ${v})`;case"rgb":return`rgb(${g}, ${d}, ${b})`;case"hsla":return`hsla(${g%360}, ${d/100}%, ${b/100}%, ${v})`;case"hsl":return`hsla(${g%360}, ${d/100}%, ${b/100}%)`;case"#":return u([g,d,b,v])}},h=(e,t,r,a)=>{if(!t.includes("hsl"))return $(t,r,a||.5);let[s,n,l,c]=o(t),i=a.replace("%",""),u=E(n)-E(i),p=E(l)+E(i)*("shade"===e?-1:1),h="tone"===e?`${u}%, ${l}%`:`${n}%, ${p<0?0:p}%`;return`${t.match(/^hsla?/)}(${s%360}, ${h}${c?", "+c:""})`};R("@blend",(e,t,r,a=.5)=>$(t,r,a)),R("@tint",(e,t,r)=>h("tint",t,"#fff",r||.5)),R("@shade",(e,t,r)=>h("shade",t,"#000",r||.5)),R("@tone",(e,t,r)=>h("tone",t,"#808080",r||.5));const f=(e,t)=>{if(!e.startsWith("rgb")&&!e.startsWith("#"))return r("func",["@luma or @contrast","hsl",": only RGB values are allowed"]),e;let[a,s,n]=t?[...t]:o(e);const l=e=>e<=.03928?e/12.92:(e=>((e+.055)/1.055)**2.4)(e);return.2126*l(a/255)+.7152*l(s/255)+.0722*l(n/255)};R("@luma",(e,t)=>f(t)),R("@contrast",(e,t,r="",a="")=>f(t)<.5?r:a),R("@gr[ae]yscale",(e,t)=>{if(t.startsWith("hsl"))return t.replace(/^(hsla?)\s*\(\s*(\d+),\s*(\d+)/,"$1($2, 0");let r=Math.round(255*f(t)),a=`rgb(${Array(3).fill(r).join(", ")})`;return t.startsWith("#")?u(a):a});const d=e=>{for(let t=0;t<m/10;t++)e=e.trim().replace(/(?:'(.+?)'|"(.+?)")+/,"$1$2").replace(/\bor\b/gi,"||").replace(/\band\b/gi,"&&").replace(/\bnot\b/gi,"!").replace(/(.+?)\bnor\b(.+)?/gi,"!($1) && !($2)").replace(/(.+?)\bnand\b(.+)?/gi,"!($1) || !($2)").replace(/(.+?)\bxor\b(.+)?/gi,"($1 && !($2)) || (!($1) && $2)").replace(/(.+?)\bxnor\b(.+)?/gi,"$1 == $2").replace(/(?!=)(!?)=(==)?(?!=)/g,"$1$2==");return e.match(/(<|<=|>|>=|==|!=|&|\||!)/)&&(e=eval(e)),["false","undefined","null","NaN",""].includes(e)&&(e=!1),e},v=e=>RegExp(s`([+-]?${b})\s*(?:${e})\s*([+-]?${b})`);R("@bitwise",(e,t)=>{let r=t.replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<");for(let e=0;e<m/10;e++)r=r.replace(RegExp(s`(?:~|!|not)\s*([+-]?${b})`),(e,t)=>eval("~"+E(t))).replace(v("or|\\|"),(e,t,r)=>eval(`(${E(t)}) | (${E(r)})`)).replace(v("nor"),(e,t,r)=>eval(`~ (${E(t)}) | (${E(r)})`)).replace(v("and|&"),(e,t,r)=>eval(`(${E(t)}) & (${E(r)})`)).replace(v("nand"),(e,t,r)=>eval(`~ (${E(t)}) & (${E(r)})`)).replace(v("xor"),(e,t,r)=>eval(`(${E(t)}) ^ (${E(r)})`)).replace(v("xnor"),(e,t,r)=>eval(`~ (${E(t)}) ^ (${E(r)})`));return r}),R("@boolean",(e,t)=>d(t)),R("@if",(e,t,r="",a="")=>d(t)?r:a),R("@breakpoint",(e,t=0,r="",a="",s="")=>{if(!t)return e;const n=(e,t,r)=>`@media (${e}-width: ${t}+${"max"===e?0:1}px) { ${r}}`;let l=(r+a).includes("{"),c=l?[r,a]:[`${r} {${a}} `,`${r} {${s}} `],i=(l?r:a).trim("force")?n("max",t,c[0]):"",o=(l?a:s).trim("force")?n("min",t,c[1]):"";return i+(i&&o?"\n":"")+o},{notrim:!0}),R("@prefix",(e,t,r)=>`-webkit-${t}: ${r}; -moz-${t}: ${r}; -ms-${t}: ${r}; -o-${t}: ${r}; ${t}: ${r};`,{nonest:!0})}for(let e=0;i.indexOf("%")>-1&&e++<$;e++)i=i.replace(/([^{}]+?){[^{}]*?}[^{}]*?%[^{}]*?{/g,(e,t)=>t.includes("%")?e:e.replace(/%/g,t.trim()));for(let e=0;i.indexOf("&")>-1&&e++<$;e++)i=i.replace(/([^{}]+?){[^{}]*?}([^{}]*?&[^{}]*?{[^{}]*})+/g,(e,t)=>t.includes("&")?e:e.replace(/&/g,t.trim()+(t.includes("%")?"<":"")));for(let e=0;i.indexOf("<")>-1&&e++<$;e++)i=i.replace(/[>+~\s]\s*[^&%{}>+~\s<]+\s*</g,"");i=i.replace(/@endvar/g,"");let O=i.match(/\$[\[(](.+?)[\])]/g);if(O)for(let e of O){let t=e.replace(/\$[\[(](.*?)(\|.*)?[\])]/,"$1").trim();i=i.replace(e,"");let a=e.includes("$(")?"variable":"argument";r(`Instances of unparsed ${a} "${t}" have been removed from the output.`)}i=i.replace(/(\s*;)+/g,";").replace(/(?<!^ *) +/gm," ").replace(/(?<![1-9]+)(0\.\d+)(?=m|s)/,(e,t)=>1e3*Number(t)+"m").replace(/0mm/g,"cm").replace(/\.?0{10,}\d/g,"").replace(/((\d)\2{9,})\d/g,"$1").replace(/(\d+)([5-9])\2{10,}\d?(?=\D)/g,(e,t)=>Number(t)+1);for(let e in u)i=i.replace(RegExp(s`\/\*STATIC#${e}\*\/`,"g"),u[e].trim());for(let e in o)i=i.replace(RegExp(s`\/\*COMMENT#${e}\*\/`,"g"),"/*"+o[e]+"*/");if(e)return i.trim();{if(document.querySelectorAll(`[data-hash="${t(i)}"]`).length)break;let e=document.createElement("style");e.innerHTML="\n"+i.trimStart().trimEnd()+"\n",e.dataset.hash=t(i),e.dataset.source=l[a],(document.head||document.body).appendChild(e)}}}function a(e,t){try{fs.readFile(e,"utf8",(r,a)=>{if(r)throw`FSReadError: Input file ${e} not found.`;fs.writeFile(t,parseNovaSheets(a).replace(/\}/g,"}\n"),e=>{if(e)throw`FSWriteError: Output file ${t} is invalid.`})})}catch(e){}}String.prototype.trim=function(e){return this.replace(/^\s*(.+?)\s*$/,"$1").replace(/\s+/g,e?"":" ")};const s=console.log;try{module.exports.parse=parseNovaSheets,module.exports.compile=a;const t=e=>process.argv[e+1]||"";let n=e=>t(1).startsWith("-")&&t(1).includes(e);if(n("-h"))r('Arguments:\n\n    novasheets [{-c, --compile}] <input file> [<output file>]\tCompile a NovaSheets file \n    novasheets {-p, --parse} "<input>"\t\t\t\tParse raw NovaSheets input from the command line \n    novasheets {-h, --help}\t\t\t\t\tDisplay this help message \n    novasheets {-v, --version}\t\t\t\t\tDisplay the current version of NovaSheets         ');else if(n("-v"))r("Current version: "+e);else if(n("-p"))s(parseNovaSheets(t(2)));else if(t(1)){let e=n("-c"),r=t(e?2:1),s=e?t(3):t(2)||r.replace(".nss",".css");a(r,s)}}catch(e){try{document.addEventListener("DOMContentLoaded",parseNovaSheets()),a=void 0}catch(e){s("An unknown error has occurred. Stack trace: "+e)}}